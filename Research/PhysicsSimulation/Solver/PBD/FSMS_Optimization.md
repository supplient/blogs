# 论文阅读：Fast Simulation of Mass-Spring Systems（最优化视点）

本文为对[Fast Simulation of Mass-Spring Systems](https://www.cs.utah.edu/~ladislav/liu13fast/liu13fast.html)的阅读笔记。

本文站的视点和原文已经截然不同了，完全可以把本文当作独立的文章进行阅读。
本文里所介绍的方法是我按个人理解提炼出来的，但内核应该是一样的。

本文跟我的[另一篇阅读笔记](https://zhuanlan.zhihu.com/p/511502862)站的视点稍有不同，所以另外写了这一篇。
我个人觉得本文的观点更利于理解。

本文里大段篇幅都和[XPBD的这篇最优化视点](https://zhuanlan.zhihu.com/p/518244355)一模一样，这是有意为之的，我想让两篇文章都独立成文，但又容易进行比较。


一些记号约定：
* 位移为$x$，速度为$v$，加速度为$a$，时间为$t$。
* 共$n$个质点。
* 所有向量均为列向量。标量对$n$维向量求导，结果为$n$维向量；$m$维向量对$n$维向量求导，结果为$m$行$n$列矩阵。
* 上标表示时刻，例如$x^n$表示第$n$个时刻的位移。
* 下标表示某个质点的值，例如$x_i$表示第$i$个质点的位移。
* 已知$n$时刻的所有状态信息，包括但不限于$x, v, a$。（注意这里为了和其他地方的标记统一，所以$n$同时具有$n$维和第$n$个时刻的含义，有点混用了）
* 质量矩阵为对角矩阵$M=diag\{m_1, m_2, \cdots, m_n\}$，其中$m_i$为第$i$个质点的质量。设质量与时间无关，始终不变。
* $\Delta t$为时步长度，即每帧之间的时间长度$Δt=t^{n+1}-t^n$。
* $∇U$为函数$U$对$x$求一阶导，$H(U)$为$U$对$x$求二阶导（即海森矩阵）。


# 1. 方法

我们的目标是要求出当前位移$x$，根据速度定义，其满足：

$$
\tag{1.1}
x^{n+1} = x^n + \int_{t^n}^{t^{n+1}}vdt
$$

速度又根据加速度定义，满足：

$$
\tag{1.2}
v = v^n + \int_{t^n}^{t}adt
$$

根据牛顿第二定律，可知：

$$
\tag{1.3}
a=M^{-1}F
$$

把式1.3代入到式1.2里，就能求出$v$关于$t$的函数，然后再代进式1.1里就能求出$x^{n+1}$关于$t^{n+1}$的函数。
不过因为$F$通常都很复杂，所以直接求积分不太现实，使用数值积分的方法近似求解比较现实。

对式1.1, 1.2**应用隐式欧拉法（第一个处理）**：

$$
\left\{
\begin{aligned}
	x^{n+1} = x^n + Δtv^{n+1} \\
	v^{n+1} = v^n + Δta^{n+1} \\
\end{aligned}
\right.
$$

这一近似就让$x^{n+1}$变得更容易求解了。为了让解更加明显，我们对它稍作变形，把下式的$v^{n+1}$代进上式，从而消掉并不是目标项的$v^{n+1}$，得到：

$$
x^{n+1}=x^n+Δtv^n+Δt^2a^{n+1}
$$

求解这一关于$x^{n+1}$的方程即可。
不过$a^{n+1}$还没有展开。
如果展开的话，因为$a^{n+1}=M^{-1}F^{n+1}$，
而$F^{n+1}$通常都是关于$x^{n+1}$或$v^{n+1}$的非线性函数，
这就导致上式变成了一个关于$x^{n+1}$的非线性方程。
我们希望能求解得更容易点。

我们先把这个非线性方程给写出来，为了方便，记$Δx=x^{n+1}-x^n-Δtv^n$。则有方程：

$$
\tag{1.4}
MΔx-Δt^2F(Δx)=0
$$

我们的目标是求解式1.4，这在解附近等价于求解以下最优化问题：

$$
\min_{Δx}\ G(Δx)=\frac{1}{2}Δx^TMΔx-Δt^2∫F(Δx)d(Δx)
$$

这是因为在没有约束条件的情况下，$G(Δx)$的极值点必定满足$\frac{∂G}{∂Δx}=MΔx-Δt^2F(Δx)=0$，也就是1.4式成立。

为了能方便地处理$F$，此处再引入一个假设：**$F$为保守力（第二个处理）**，即有势能场$U$满足：

$$
∇U=-F
$$

则最优化问题可记为：

$$
\tag{1.5}
\min_{Δx}\ G(Δx)=\frac{1}{2}Δx^TMΔx-Δt^2U(Δx)
$$

$G$的前半项$\frac{1}{2}Δx^TMΔx$是个关于$Δx$的二次项，求它的极值点很容易。
所以$G$的复杂度由其后半项$U$来决定。
通常而言，$U$都挺复杂的，不是一个简单的二次函数。


------
（下文和[XPBD的那篇](https://zhuanlan.zhihu.com/p/518244355)产生分歧）

为了引出后文，我们先尝试一种不可行的方法。

怎样的函数比较好求极值呢？二次函数最好求，因为它的梯度是个线性项，所以求解极值点条件（目标函数的梯度为0）时就是解个线性方程组，而解线性方程组一般认为都是比较容易的。

所以我们希望$U$是个二次函数。

一个简单的想法是将$U$泰勒展开：

$$
\tag{1.6}
U(x^{n+1})≈U(x^n)+∇U(x^n)^TΔx+\frac{1}{2}Δx^TH(U)(x^n)Δx
$$

右边这个近似函数显然是个关于$Δx$的二次函数。

这可能也确实是一种做法，可能也有人这么做过（有待调研）。

这一做法存在的问题是它需要把$H(U)$给写出来，可是不是所有$U$都那么容易把$H(U)$给写出来的。

下面我们以弹簧约束为例讨论该问题（后文中全部都是在讨论弹簧约束）。

设有一组弹簧约束$C=[C_1\ C_2\ \cdots\ C_m]^T$, $C_i=||x_{s_i}-x_{t_i}||-l_i$, 其中$s_i, t_i, l_i$为已知量。

则弹簧势能$U=\frac{1}{2}C^TC$，它的梯度为：

$$
∇U=∇C^TC = \begin{bmatrix}
	\sum_i\frac{∂C_i}{∂x_j}C_i
\end{bmatrix}_{n×1}
$$

这里为了简略，只写了第$j$项的表达式，$∇U$为一个n维的列向量。
显然，它的二阶导$H(U)$已经相当难写出来了。
所以直接对弹性势能进行泰勒展开将其转换为二次函数是件困难的事情。

为了下文讨论的清晰直观，我们再引入一个新的常数矩阵$L$:

$$
A_{ij} = 
\left\{
\begin{aligned}
	1&, if\ j=s_i \\
	-1&, if\ j=t_i \\
	0&, otherwise
\end{aligned}
\right.
$$

其满足：

$$
Ax=
\begin{bmatrix}
	x_{s_1}-x_{t_1} \\
	x_{s_2}-x_{t_2} \\
	⋯ \\
	x_{s_m}-x_{t_m} \\
\end{bmatrix}
$$

为了能找到一个$U$的二次函数近似，我们先把$U$给用另一种记法给展开：

$$
\begin{aligned}
	U 
	&= \frac{1}{2}C^TC \\
	&= \frac{1}{2}\sum C_i^2 \\
	&= \frac{1}{2}\sum[(x_{s_i}-x_{t_i})^T(x_{s_i}-x_{t_i})-2l_i||x_{s_i}-x_{t_i}||+l_i^2] \\
	&= \frac{1}{2}x^TA^TAx - \frac{1}{2}\sum l_i||x_{s_i}-x_{t_i}||+\sum l_i^2
\end{aligned}
$$

注意到$U$可以被分为三部分处理：二次项、复杂项、常数项。设：

$$
\begin{aligned}
	L &= A^TA \\
	D(x) &= -\frac{1}{2}\sum l_i||x_{s_i}-x_{t_i}|| \\
	C &= \sum l_i^2
\end{aligned}
$$

则$U$可以写成：

$$
\tag{1.7}
U = \frac{1}{2}x^TLx+D(x)+C
$$

注意到二次项和常数项的二阶导非常容易写出来：

$$
\begin{aligned}
H(\frac{1}{2}x^TLx) = L \\
H(C) = 0
\end{aligned}
$$

所以问题其实聚焦在这个$D(x)$的二阶导$H(D)$很难写出来。

因此我们就做了**第三个处理：设$H(D)=0$**。此时有$U$的二阶导满足：

$$
\tag{1.8}
H(U) = L
$$

在这基础上再做**第四个处理：把$U$给泰勒展开，近似为一个二次函数。**

把式1.8代入式1.6的泰勒展开里面，得到近似函数$U^*$：

$$
\tag{1.9}
U^*(Δx)=U(x^n)+∇U(x^n)^TΔx+\frac{1}{2}Δx^TLΔx
$$

$U^*$里还算比较难写出来的就只有$∇U(x^n)$了，这个么，就用勤劳的双手解决吧！（上文中已经给出了$∇U$）

用新势能函数$U^*$取代式1.5的最优化问题里的$U$，得到新问题：

$$
\tag{1.10}
\min_{Δx}\ G(Δx)=\frac{1}{2}Δx^TMΔx-Δt^2U^*(Δx)
$$

其中$U^*$是个关于$Δx$的二次函数。于是式1.10里的$G(Δx)$就是个关于$Δx$的二次函数，求它的极值点非常容易，我们对$Δx$求导，得到极值点条件方程：

$$
\tag{1.11}
\frac{∂G}{∂Δx} = MΔx - Δt^2[∇U(x^n)+LΔx] = 0
$$

上式中只有关于$Δx$的线性项，所以它也就只是个$\Delta x$的线性方程组。至此，我们就得到了一套求解式1.1的方法。


# 2. 讨论
我们为了求解式1.1里的$x^{n+1}$，一共做了四个处理：
1. 应用隐式欧拉法计算数值积分
2. 假设作用力均为保守力，从而可以将原问题转换为最优化问题
3. 设$U$里的复杂项$D$的二阶导$H(D)=0$
4. 在第三个处理的基础上，用$U$的二阶泰勒展开近似$U$

第一、三、四个处理是降低求解难度的核心步骤：
* 第一个处理用近似方法计算数值积分。
* 第三、四个处理相当于是在对$U$做二阶泰勒展开时，只对$U$里的复杂项做了一阶泰勒展开，也就是只把那一部分给线性化了，对其他部分还是做二阶泰勒展开。
	* 通常的做法是把整个$U$都给一阶泰勒展开的。

这一方法可能也能迁移到其他形式的势能上吧，只要能提取出来二次项就行了。