#! https://zhuanlan.zhihu.com/p/518244355
# 论文阅读：XPBD（最优化视点）

本文为对[XPBD: Position-Based Simulation of Compliant Constrained Dynamics](https://matthias-research.github.io/pages/publications/XPBD.pdf)的阅读笔记。

本文站的视点和原文已经截然不同了，完全可以把本文当作独立的文章进行阅读。

本文里所介绍的方法是我按个人理解提炼出来的，和原文也稍许有一些些出入（例如我没有近似$g(x,λ)=0$），但内核应该是一样的。

本文跟我的[另一篇对XPBD的阅读笔记](https://zhuanlan.zhihu.com/p/510654097)站的视点稍有不同，所以另外写了这一篇。
我个人是觉得这篇里的内容更加易于理解，但也和原文出入更大。

一些记号约定：
* 位移为$x$，速度为$v$，加速度为$a$，时间为$t$。
* 共$n$个质点。
* 所有向量均为列向量。标量对$n$维向量求导，结果为$n$维向量；$m$维向量对$n$维向量求导，结果为$m$行$n$列矩阵。
* 上标表示时刻，例如$x^n$表示第$n$个时刻的位移。
* 下标表示某个质点的值，例如$x_i$表示第$i$个质点的位移。
* 已知$n$时刻的所有状态信息，包括但不限于$x, v, a$。（注意这里为了和其他地方的标记统一，所以$n$同时具有$n$维和第$n$个时刻的含义，有点混用了）
* 质量矩阵为对角矩阵$M=diag\{m_1, m_2, \cdots, m_n\}$，其中$m_i$为第$i$个质点的质量。设质量与时间无关，始终不变。
* $\Delta t$为时步长度，即每帧之间的时间长度$Δt=t^{n+1}-t^n$。

# 1. 方法

我们的目标是要求出当前位移$x$，根据速度定义，其满足：

$$
\tag{1.1}
x^{n+1} = x^n + \int_{t^n}^{t^{n+1}}vdt
$$

速度又根据加速度定义，满足：

$$
\tag{1.2}
v = v^n + \int_{t^n}^{t}adt
$$

根据牛顿第二定律，可知：

$$
\tag{1.3}
a=M^{-1}F
$$

把式1.3代入到式1.2里，就能求出$v$关于$t$的函数，然后再代进式1.1里就能求出$x^{n+1}$关于$t^{n+1}$的函数。
不过因为$F$通常都很复杂，所以直接求积分不太现实，使用数值积分的方法近似求解比较现实。

对式1.1, 1.2**应用隐式欧拉法（第一个处理）**：

$$
\left\{
\begin{aligned}
	x^{n+1} = x^n + Δtv^{n+1} \\
	v^{n+1} = v^n + Δta^{n+1} \\
\end{aligned}
\right.
$$

这一近似就让$x^{n+1}$变得更容易求解了。为了让解更加明显，我们对它稍作变形，把下式的$v^{n+1}$代进上式，从而消掉并不是目标项的$v^{n+1}$，得到：

$$
x^{n+1}=x^n+Δtv^n+Δt^2a^{n+1}
$$

求解这一关于$x^{n+1}$的方程即可。
不过$a^{n+1}$还没有展开。
如果展开的话，因为$a^{n+1}=M^{-1}F^{n+1}$，
而$F^{n+1}$通常都是关于$x^{n+1}$或$v^{n+1}$的非线性函数，
这就导致上式变成了一个关于$x^{n+1}$的非线性方程。
我们希望能求解得更容易点。

我们先把这个非线性方程给写出来，为了方便，记$Δx=x^{n+1}-x^n-Δtv^n$。则有方程：

$$
\tag{1.4}
MΔx-Δt^2F(Δx)=0
$$

我们的目标是求解式1.4，这在解附近等价于求解以下最优化问题：

$$
\min_{Δx}\ G(Δx)=\frac{1}{2}Δx^TMΔx-Δt^2∫F(Δx)d(Δx)
$$

这是因为在没有约束条件的情况下，$G(Δx)$的极值点必定满足$\frac{∂G}{∂Δx}=MΔx-Δt^2F(Δx)=0$，也就是1.4式成立。

为了能方便地处理$F$，此处再引入一个假设：**$F$为保守力（第二个处理）**，即有势能场$U$满足：

$$
∇U=-F
$$

则最优化问题可记为：

$$
\tag{1.5}
\min_{Δx}\ G(Δx)=\frac{1}{2}Δx^TMΔx-Δt^2U(Δx)
$$

$G$的前半项$\frac{1}{2}Δx^TMΔx$是个关于$Δx$的二次项，求它的极值点很容易。
所以$G$的复杂度由其后半项$U$来决定。
通常而言，$U$都挺复杂的，不是一个简单的二次函数。

所以我们这里再引入一个假设：**U为关于某个变量的二次函数（第三个处理）**，即：

$$
U=\frac{1}{2}C^Tα^{-1}C
$$

其中$C:R^n→R^m$，$α$为一个$m$维的对角矩阵。（注意这一处理没有近似，也并没有显著降低求解难度，但它会对$U$的结构做出一定的限制，以便后续处理。）

在这一假设下求解式1.5的话，如果$C$复杂的话，那依然要求解一个关于$Δx$的非线性方程。写出来的话就是：

$$
\frac{∂G}{∂Δx}=MΔx-Δt^2∇C^Tα^{-1}C=0
$$

只要$∇Cα^{-1}C$不是关于$Δx$的线性函数，那这就依然是个关于$Δx$的非线性方程。

此处我们**引入一个新变量$λ$，并重新构造势能场（第四个处理）**：

$$
U^*=-λ^TC-\frac{1}{2}λ^Tαλ
$$

$U^*$的特点是当$\frac{∂U^*}{∂λ}=0$时，$U^*=U$（这是因为$\frac{∂U^*}{∂λ}=0 ⇒ λ=-α^{-1}C ⇒ U^*=C^Tα^{-1}C-\frac{1}{2}C^Tα^{-1}C=\frac{1}{2}C^Tα^{-1}C=U$）。
这一特点意味着$U^*$在其极值点上总是与$U$等价。

此时我们就得到了一个和式1.5同解的二元函数求极值的问题：

$$
\tag{1.6}
\min_{Δx,λ}\ G(Δx, λ)=\frac{1}{2}Δx^TMΔx-Δt^2U^*(Δx, λ)
$$

（注意这一处理依然没有降低求解难度，但是它扩大了最优化问题的搜索空间，在优化$U(C,λ)$时，搜索空间从$λ=-α^{-1}C$的直线上扩展到了整个$λ-C$平面，后文详述）

求解该问题依然复杂，这里我们就引入了惯用的近似假设：**设$U^*$关于$Δx$的二阶导数$H(U^*)$为0（第五个处理）**。也即是说$U^*$是个关于$Δx$的线性函数。

于是式1.6里的$G(Δx, λ)$就是个关于$Δx$的二次函数，也是个关于$λ$的二次函数。求它的极值点非常容易，我们分别对$Δx$和$λ$求导，得到方程组：

$$
\tag{1.7}
\left\{
\begin{aligned}
	\frac{∂G}{∂Δx}&=MΔx-Δt^2∇C^Tλ&=0 \\
	\frac{∂G}{∂λ} &=C+αλ         &=0 \\
\end{aligned}
\right.
$$

因为假设了$H(U^*)=0$，所以$∇C^Tλ$是个常数项，于是上式就是个关于$Δx, λ$的线性方程组。至此，我们就得到了一套求解式1.1的方法。

实际求的时候可以对$U^*(x^{n+1})$在$\tilde{x}=x^n+Δtv^n$做泰勒展开：

$$
U^*(x^{n+1})=U^*(\tilde{x})+∇U^*(\tilde{x})Δx+O(Δx^2)
$$

然后略去二次项的话，那就达成了假设$H(U^*)=0$的目的。



# 2. 讨论
我们为了求解式1.1里的$x^{n+1}$，一共做了五个处理：
1. 应用隐式欧拉法计算数值积分
2. 假设作用力均为保守力，从而可以将原问题转换为最优化问题
3. 规定$U=\frac{1}{2}C^Tα^{-1}C$，限制了$U$的结构。
4. 引入新变量，并构造一个新的势能场$U^*=-λ^TC-\frac{1}{2}λ^Tαλ$
5. 假设$H(U^*)=0$，将目标函数变为一个二次函数。

第一、五个处理是降低求解难度的核心步骤：
* 第一个处理用近似方法计算数值积分。
* 第五个处理相当于是应用了一次泰勒展开，将一个复杂函数线性化了。

第二、三个处理限定了力的性质，为第四个处理铺路：
* 第二个处理限定作用力必须为保守力，也就必须有一个势能场对应它。
* 第三个处理限定了这一势能场的形状，规定它必须是关于某个变量的二次函数。

第四个处理扩大了搜索空间，修正了解空间，从而提高了近似解的准确度。
这一点需要稍微深入讨论一下。

假设我们不引入$λ$，而是直接假设$H(U)=0$，那么依然是可以将式1.5的目标函数$G$转变成一个二次函数进行快速求解的。
但是注意到求解式1.5时，我们仅在$x$轴上进行搜索，而因为我们引入了近似$H(U)=0$，所以此时$x$轴上的最小值可能已经离精确解很远了。

为了形象直观地理解这一问题，
我们考虑一个函数$z=x^2$，
显然它的极小值点是在$x=0$的位置上。
如果我们对这一函数做稍许的扰动，
得到一个新函数$z'=(x-5)^2$，
那么此时极小值点就是在$x=5$上了，
跟原来的$x=0$相距甚远。

为此我们需要扩大搜索空间，并修正解空间，以更加接近精确解。
引入辅助变量$y$，
并设新函数$ϕ=(x-5)^2+xy$，
简单求导后可以得到新函数的极值点为$x=0, y=10$，
发现它回到了原来的极值点$x=0$上。

我们近似$H(U)=0$的结果和上面的“稍许的扰动”是类似的，
所以我们在这一新函数上的搜索结果和原函数的极值点可能相距甚远。
为此我们引入了辅助变量$λ$，并设新的势能函数$U^*=-λ^TC-\frac{1}{2}λ^Tαλ$，
这跟上面引入$y$和$ϕ$是类似的，
目的当然也是雷同的：
我们想尽量抵消掉一些近似$H(U)=0$带来的扰动，以得到更精确的解。


